"use strict";var N=require("seedrandom"),d=(e=>(e[e.New=0]="New",e[e.Learning=1]="Learning",e[e.Review=2]="Review",e[e.Relearning=3]="Relearning",e))(d||{}),n=(e=>(e[e.Manual=0]="Manual",e[e.Again=1]="Again",e[e.Hard=2]="Hard",e[e.Good=3]="Good",e[e.Easy=4]="Easy",e))(n||{});Date.prototype.scheduler=function(e,t){return f(this,e,t)},Date.prototype.diff=function(e,t){return x(this,e,t)},Date.prototype.format=function(){return M(this)},Date.prototype.dueFormat=function(e,t,a){return R(this,e,t,a)};function f(e,t,a){return new Date(a?h(e).getTime()+t*24*60*60*1e3:h(e).getTime()+t*60*1e3)}function x(e,t,a){if(!e||!t)throw new Error("Invalid date");const r=h(e).getTime()-h(t).getTime();let s=0;switch(a){case"days":s=Math.floor(r/(24*60*60*1e3));break;case"minutes":s=Math.floor(r/(60*1e3));break}return s}function M(e){const t=h(e),a=t.getFullYear(),r=t.getMonth()+1,s=t.getDate(),i=t.getHours(),l=t.getMinutes(),o=t.getSeconds();return`${a}-${y(r)}-${y(s)} ${y(i)}:${y(l)}:${y(o)}`}function y(e){return e<10?`0${e}`:`${e}`}const p=[60,60,24,31,12],g=["second","min","hour","day","month","year"];function R(e,t,a,r=g){e=h(e),t=h(t),r.length!==g.length&&(r=g);let s=e.getTime()-t.getTime(),i;for(s/=1e3,i=0;i<p.length&&!(s<p[i]);i++)s/=p[i];return`${Math.floor(s)}${a?r[i]:""}`}function h(e){if(typeof e=="object"&&e instanceof Date)return e;if(typeof e=="string"){const t=Date.parse(e);if(isNaN(t))throw new Error(`Invalid date:[${e}]`);return new Date(t)}else if(typeof e=="number")return new Date(e);throw new Error(`Invalid date:[${e}]`)}function _(e){if(typeof e=="string"){const t=e.charAt(0).toUpperCase(),a=e.slice(1).toLowerCase(),r=d[`${t}${a}`];if(r===void 0)throw new Error(`Invalid state:[${e}]`);return r}else if(typeof e=="number")return e;throw new Error(`Invalid state:[${e}]`)}function E(e){if(typeof e=="string"){const t=e.charAt(0).toUpperCase(),a=e.slice(1).toLowerCase(),r=n[`${t}${a}`];if(r===void 0)throw new Error(`Invalid rating:[${e}]`);return r}else if(typeof e=="number")return e;throw new Error(`Invalid rating:[${e}]`)}const k=[n.Again,n.Hard,n.Good,n.Easy],T=[{start:2.5,end:7,factor:.15},{start:7,end:20,factor:.1},{start:20,end:1/0,factor:.05}];function D(e,t,a){let r=1;for(const l of T)r+=l.factor*Math.max(Math.min(e,l.end)-l.start,0);e=Math.min(e,a);let s=Math.max(2,Math.round(e-r));const i=Math.min(Math.round(e+r),a);return e>t&&(s=Math.max(s,t+1)),s=Math.min(s,i),{min_ivl:s,max_ivl:i}}class S{again;hard;good;easy;last_review;last_elapsed_days;copy(t){return{...t}}constructor(t,a){this.last_review=t.last_review||t.due,this.last_elapsed_days=t.elapsed_days,t.elapsed_days=t.state===d.New?0:a.diff(t.last_review,"days"),t.last_review=a,t.reps+=1,this.again=this.copy(t),this.hard=this.copy(t),this.good=this.copy(t),this.easy=this.copy(t)}update_state(t){return t===d.New?(this.again.state=d.Learning,this.hard.state=d.Learning,this.good.state=d.Learning,this.easy.state=d.Review):t===d.Learning||t===d.Relearning?(this.again.state=t,this.hard.state=t,this.good.state=d.Review,this.easy.state=d.Review):t===d.Review&&(this.again.state=d.Relearning,this.hard.state=d.Review,this.good.state=d.Review,this.easy.state=d.Review,this.again.lapses+=1),this}schedule(t,a,r,s){return this.again.scheduled_days=0,this.hard.scheduled_days=a,this.good.scheduled_days=r,this.easy.scheduled_days=s,this.again.due=f(t,5),this.hard.due=a>0?f(t,a,!0):f(t,10),this.good.due=f(t,r,!0),this.easy.due=f(t,s,!0),this}record_log(t,a){return{[n.Again]:{card:this.again,log:{rating:n.Again,state:t.state,due:this.last_review,stability:t.stability,difficulty:t.difficulty,elapsed_days:t.elapsed_days,last_elapsed_days:this.last_elapsed_days,scheduled_days:t.scheduled_days,review:a}},[n.Hard]:{card:this.hard,log:{rating:n.Hard,state:t.state,due:this.last_review,stability:t.stability,difficulty:t.difficulty,elapsed_days:t.elapsed_days,last_elapsed_days:this.last_elapsed_days,scheduled_days:t.scheduled_days,review:a}},[n.Good]:{card:this.good,log:{rating:n.Good,state:t.state,due:this.last_review,stability:t.stability,difficulty:t.difficulty,elapsed_days:t.elapsed_days,last_elapsed_days:this.last_elapsed_days,scheduled_days:t.scheduled_days,review:a}},[n.Easy]:{card:this.easy,log:{rating:n.Easy,state:t.state,due:this.last_review,stability:t.stability,difficulty:t.difficulty,elapsed_days:t.elapsed_days,last_elapsed_days:this.last_elapsed_days,scheduled_days:t.scheduled_days,review:a}}}}}const $=.95,z=36500,A=[.5701,1.4436,4.1386,10.9355,5.1443,1.2006,.8627,.0362,1.629,.1342,1.0166,2.1174,.0839,.3204,1.4676,.219,2.8237],C=!1,I="3.5.3",F=e=>({request_retention:(e==null?void 0:e.request_retention)||$,maximum_interval:(e==null?void 0:e.maximum_interval)||z,w:(e==null?void 0:e.w)||A,enable_fuzz:(e==null?void 0:e.enable_fuzz)||C});function q(e,t){const a={due:e?h(e):new Date,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:0,lapses:0,state:d.New,last_review:void 0};return t&&typeof t=="function"?t(a):a}const w=-.5,m=19/81;class H{param;intervalModifier;seed;constructor(t){this.param=F(t),this.intervalModifier=(Math.pow(this.param.request_retention,1/w)-1)/m}init_ds(t){t.again.difficulty=this.init_difficulty(n.Again),t.again.stability=this.init_stability(n.Again),t.hard.difficulty=this.init_difficulty(n.Hard),t.hard.stability=this.init_stability(n.Hard),t.good.difficulty=this.init_difficulty(n.Good),t.good.stability=this.init_stability(n.Good),t.easy.difficulty=this.init_difficulty(n.Easy),t.easy.stability=this.init_stability(n.Easy)}next_ds(t,a,r,s){t.again.difficulty=this.next_difficulty(a,n.Again),t.again.stability=this.next_forget_stability(a,r,s),t.hard.difficulty=this.next_difficulty(a,n.Hard),t.hard.stability=this.next_recall_stability(a,r,s,n.Hard),t.good.difficulty=this.next_difficulty(a,n.Good),t.good.stability=this.next_recall_stability(a,r,s,n.Good),t.easy.difficulty=this.next_difficulty(a,n.Easy),t.easy.stability=this.next_recall_stability(a,r,s,n.Easy)}init_stability(t){return Math.max(this.param.w[t-1],.1)}init_difficulty(t){return+Math.min(Math.max(this.param.w[4]-(t-3)*this.param.w[5],1),10).toFixed(8)}apply_fuzz(t,a,r){if(!r||t<2.5)return Math.round(t);const s=N(this.seed)(),{min_ivl:i,max_ivl:l}=D(t,a,this.param.maximum_interval);return Math.floor(s*(l-i+1)+i)}next_interval(t,a,r=this.param.enable_fuzz){const s=Math.min(Math.max(1,Math.round(t*this.intervalModifier)),this.param.maximum_interval);return this.apply_fuzz(s,a,r)}next_difficulty(t,a){const r=t-this.param.w[6]*(a-3);return this.constrain_difficulty(this.mean_reversion(this.param.w[4],r))}constrain_difficulty(t){return Math.min(Math.max(+t.toFixed(8),1),10)}mean_reversion(t,a){return+(this.param.w[7]*t+(1-this.param.w[7])*a).toFixed(8)}next_recall_stability(t,a,r,s){const i=n.Hard===s?this.param.w[15]:1,l=n.Easy===s?this.param.w[16]:1;return+(a*(1+Math.exp(this.param.w[8])*(11-t)*Math.pow(a,-this.param.w[9])*(Math.exp((1-r)*this.param.w[10])-1)*i*l)).toFixed(8)}next_forget_stability(t,a,r){return+(this.param.w[11]*Math.pow(t,-this.param.w[12])*(Math.pow(a+1,this.param.w[13])-1)*Math.exp((1-r)*this.param.w[14])).toFixed(8)}forgetting_curve(t,a){return+Math.pow(1+m*t/a,w).toFixed(8)}}class P extends H{constructor(t){super(t)}preProcessCard(t){return{...t,state:_(t.state),due:h(t.due),last_review:t.last_review?h(t.last_review):void 0}}preProcessDate(t){return h(t)}preProcessLog(t){return{...t,due:h(t.due),rating:E(t.rating),state:_(t.state),review:h(t.review)}}repeat(t,a,r){const s=this.preProcessCard(t);a=this.preProcessDate(a);const i=new S(s,a).update_state(s.state);this.seed=String(a.getTime())+String(s.reps);let l,o,u;const c=s.elapsed_days;switch(s.state){case d.New:this.init_ds(i),i.again.due=a.scheduler(1),i.hard.due=a.scheduler(5),i.good.due=a.scheduler(10),l=this.next_interval(i.easy.stability,c),i.easy.scheduled_days=l,i.easy.due=a.scheduler(l,!0);break;case d.Learning:case d.Relearning:u=0,o=this.next_interval(i.good.stability,c),l=Math.max(this.next_interval(i.easy.stability,c),o+1),i.schedule(a,u,o,l);break;case d.Review:{const L=s.difficulty,b=s.stability,G=this.forgetting_curve(c,b);this.next_ds(i,L,b,G),u=this.next_interval(i.hard.stability,c),o=this.next_interval(i.good.stability,c),u=Math.min(u,o),o=Math.max(o,u+1),l=Math.max(this.next_interval(i.easy.stability,c),o+1),i.schedule(a,u,o,l);break}}const v=i.record_log(s,a);return r&&typeof r=="function"?r(v):v}get_retrievability=(t,a)=>{const r=this.preProcessCard(t);if(a=this.preProcessDate(a),r.state!==d.Review)return;const s=Math.max(a.diff(r.last_review,"days"),0);return(this.forgetting_curve(s,r.stability)*100).toFixed(2)+"%"};rollback(t,a,r){const s=this.preProcessCard(t),i=this.preProcessLog(a);if(i.rating===n.Manual)throw new Error("Cannot rollback a manual rating");let l,o,u;switch(i.state){case d.New:l=i.due,o=void 0,u=0;break;case d.Learning:case d.Relearning:case d.Review:l=i.review,o=i.due,u=s.lapses-(i.rating===n.Again&&i.state===d.Review?1:0);break}const c={...s,due:l,stability:i.stability,difficulty:i.difficulty,elapsed_days:i.last_elapsed_days,scheduled_days:i.scheduled_days,reps:Math.max(0,s.reps-1),lapses:Math.max(0,u),state:i.state,last_review:o};return r&&typeof r=="function"?r(c):c}forget(t,a,r=!1,s){const i=this.preProcessCard(t);a=this.preProcessDate(a);const l=i.state===d.New?0:a.diff(i.last_review,"days"),o={rating:n.Manual,state:i.state,due:i.due,stability:i.stability,difficulty:i.difficulty,elapsed_days:0,last_elapsed_days:i.elapsed_days,scheduled_days:l,review:a},u={card:{...i,due:a,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:r?0:i.reps,lapses:r?0:i.lapses,state:d.New,last_review:i.last_review},log:o};return s&&typeof s=="function"?s(u):u}reschedule(t,a={}){if(!Array.isArray(t))throw new Error("cards must be an array");const r=[];for(const s of t){if(_(s.state)!==d.Review||!s.last_review)continue;const i=Math.floor(s.scheduled_days),l=this.next_interval(+s.stability.toFixed(2),Math.round(s.elapsed_days),a.enable_fuzz??!0);if(l===i||l===0)continue;const o={...s};o.scheduled_days=l;const u=f(o.last_review,l,!0);a.dateHandler&&typeof a.dateHandler=="function"?o.due=a.dateHandler(u):o.due=u,r.push(o)}return r}}const O=e=>new P(e||{});exports.DECAY=w,exports.FACTOR=m,exports.FSRS=P,exports.FSRSAlgorithm=H,exports.FSRSVersion=I,exports.Grades=k,exports.Rating=n,exports.SchedulingCard=S,exports.State=d,exports.createEmptyCard=q,exports.date_diff=x,exports.date_scheduler=f,exports.default_enable_fuzz=C,exports.default_maximum_interval=z,exports.default_request_retention=$,exports.default_w=A,exports.fixDate=h,exports.fixRating=E,exports.fixState=_,exports.formatDate=M,exports.fsrs=O,exports.generatorParameters=F,exports.get_fuzz_range=D,exports.show_diff_message=R,module.exports=Object.assign(exports.default||{},exports);
//# sourceMappingURL=index.cjs.map
